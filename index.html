<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rolê Certo | Eventos Sociais</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #f05537;
            --secondary: #39364f;
            --light: #f8f7fa;
            --dark: #1e0a3c;
            --gray: #6f7287;
            --verde: #4CAF50;
            --laranja: #FF9800;
            --roxo: #9C27B0;
            --azul: #2196F3;
            --cinza-claro: #f8f9fa;
            --cinza-escuro: #343a40;
            --branco: #ffffff;
            --sombra: 0 8px 24px rgba(0, 0, 0, 0.12);
            --sombra-card: 0 6px 16px rgba(0, 0, 0, 0.1);
            --borda: 1px solid rgba(0, 0, 0, 0.08);
            --transicao: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: var(--light);
            color: var(--secondary);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        header {
            background: linear-gradient(90deg, var(--dark) 0%, #4a154b 100%);
            color: var(--branco);
            padding: 15px 5%;
            border-radius: 16px;
            box-shadow: var(--sombra);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .logo-main {
            font-size: 2.2rem;
            font-weight: 800;
            letter-spacing: -0.5px;
            color: var(--branco);
        }

        .logo-sub {
            font-size: 1rem;
            font-weight: 500;
            opacity: 0.9;
            color: var(--branco);
        }

        .nav-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .nav-btn {
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transicao);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            color: var(--branco);
        }
        
        .nav-btn.nav-btn-primary {
            background: var(--primary);
            border-color: var(--primary);
        }

        .nav-btn:hover, .nav-btn.active {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .nav-btn.nav-btn-primary:hover {
            background: #d04a30;
            border-color: #d04a30;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            min-height: 70vh;
        }

        .hero {
            background: linear-gradient(rgba(30, 10, 60, 0.85), rgba(30, 10, 60, 0.85)), url('https://images.unsplash.com/photo-1511795409834-ef04bbd61622?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80') center/cover;
            color: white;
            padding: 80px 20px;
            text-align: center;
            border-radius: 16px;
            margin-bottom: 40px;
            box-shadow: var(--sombra);
        }

        .hero h1 {
            font-size: 2.8rem;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .hero p {
            font-size: 1.2rem;
            max-width: 700px;
            margin: 0 auto 40px;
            opacity: 0.9;
        }

        .hero-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 28px;
            border-radius: 4px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: var(--transicao);
            cursor: pointer;
            border: none;
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid white;
            color: white;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .section {
            padding: 40px 0;
        }

        .section-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .section-header h2 {
            font-size: 2.2rem;
            margin-bottom: 15px;
            color: var(--dark);
        }

        .section-header p {
            color: var(--gray);
            max-width: 700px;
            margin: 0 auto;
            font-size: 1.1rem;
        }
        
        .category-filters {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
        }

        .filter-btn {
            background: var(--branco);
            border: 1px solid rgba(0,0,0,0.1);
            color: var(--gray);
            padding: 8px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transicao);
            font-size: 0.9rem;
        }

        .filter-btn:hover {
            background: var(--light);
            border-color: var(--primary);
            color: var(--primary);
        }

        .filter-btn.active {
            background: var(--primary);
            color: var(--branco);
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(240, 85, 55, 0.3);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .event-card {
            background: var(--branco);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--sombra-card);
            transition: var(--transicao);
            display: flex;
            flex-direction: column;
            height: 100%;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            padding: 12px 16px;
            background: var(--light);
            border-bottom: var(--borda);
        }

        .event-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--secondary);
        }

        .event-badge {
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-block;
        }

        .card-content {
            padding: 16px;
            flex-grow: 1;
        }

        .event-info {
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 0.9rem;
        }

        .event-info i {
            min-width: 20px;
            color: var(--primary);
            font-size: 1rem;
            margin-top: 3px;
        }
        
        .event-creator-link {
            color: var(--primary);
            font-weight: 600;
            text-decoration: none;
        }
        
        .event-creator-link:hover {
            text-decoration: underline;
        }

        .card-footer {
            display: flex;
            padding: 0 16px 16px;
            gap: 10px;
        }

        .card-btn {
            flex: 1;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--borda);
            background: var(--light);
            color: var(--secondary);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transicao);
            font-size: 0.85rem;
        }

        .card-btn:hover {
            background: var(--primary);
            color: var(--branco);
            border-color: var(--primary);
        }

        .form-container, .auth-container, .profile-container {
            background: var(--branco);
            border-radius: 16px;
            box-shadow: var(--sombra-card);
            padding: 30px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .auth-container {
            max-width: 450px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border: var(--borda);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--light);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn-submit {
            background: var(--primary);
            color: var(--branco);
            border: none;
            padding: 14px 30px;
            border-radius: 4px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: block;
            width: 100%;
            margin-top: 10px;
            transition: var(--transicao);
        }

        .btn-submit:hover {
            background: #d04a30;
        }
        
        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .auth-toggle a {
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
        }
        
        .error-message {
            color: #f44336;
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.2);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            display: none;
        }

        /* Profile Page */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .profile-pic-container {
            position: relative;
        }

        .profile-pic {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--branco);
            box-shadow: var(--sombra-card);
        }
        
        #profile-pic-upload {
            display: none;
        }

        #upload-pic-label {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: var(--primary);
            color: var(--branco);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid var(--branco);
            transition: var(--transicao);
        }
        
        #upload-pic-label:hover {
            transform: scale(1.1);
        }
        
        .profile-info h3 {
            font-size: 1.8rem;
            color: var(--dark);
        }
        
        .profile-info p {
            color: var(--gray);
        }

        .floating-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--branco);
            border: none;
            box-shadow: 0 6px 20px rgba(240, 85, 55, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            z-index: 100;
            transition: var(--transicao);
        }

        .floating-btn:hover {
            transform: scale(1.1);
        }

        .loading {
            display: flex;
            justify-content: center;
            padding: 30px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .categoria-musica .event-badge { background: rgba(76, 175, 80, 0.1); color: #4CAF50; }
        .categoria-artes .event-badge { background: rgba(156, 39, 176, 0.1); color: #9C27B0; }
        .categoria-teatro .event-badge { background: rgba(255, 152, 0, 0.1); color: #FF9800; }
        .categoria-literatura .event-badge { background: rgba(33, 150, 243, 0.1); color: #2196F3; }
        .categoria-intervencoes .event-badge { background: rgba(244, 67, 54, 0.1); color: #f44336; }
        .categoria-cultura .event-badge { background: rgba(0, 150, 136, 0.1); color: #009688; }
        .categoria-natureza .event-badge { background: rgba(121, 85, 72, 0.1); color: #795548; }
        .categoria-barzinho .event-badge { background: rgba(255, 193, 7, 0.1); color: #FFC107; }
        .categoria-trilha .event-badge { background: rgba(139, 195, 74, 0.1); color: #8BC34A; }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <div class="logo-main">Rolê Certo</div>
            <div class="logo-sub">Organize seus eventos sociais</div>
        </div>
        
        <div class="nav-container" id="nav-container">
            <!-- Os botões de navegação serão inseridos aqui pelo JS -->
        </div>
    </header>

    <div class="container">
        <!-- PÁGINA PRINCIPAL (EVENTOS) -->
        <div id="eventos" class="page active">
            <section class="hero">
                <h1>Encontre seu próximo rolê favorito</h1>
                <p>Descubra os melhores eventos, encontros e experiências sociais perto de você</p>
                <div class="hero-buttons">
                    <button class="btn btn-primary" id="explore-events">
                        <i class="fas fa-search"></i> Explorar eventos
                    </button>
                    <button class="btn btn-outline" id="create-event-hero">
                        <i class="fas fa-plus"></i> Criar evento
                    </button>
                </div>
            </section>
            <div class="section">
                <div class="section-header">
                    <h2>Eventos Ativos</h2>
                    <p>Filtre por categoria para encontrar o que mais te interessa</p>
                </div>
                <div class="category-filters" id="category-filters">
                    <button class="filter-btn active" data-category="all">Todos</button>
                    <button class="filter-btn" data-category="barzinho">Barzinho</button>
                    <button class="filter-btn" data-category="trilha">Trilha</button>
                    <button class="filter-btn" data-category="musica">Música</button>
                    <button class="filter-btn" data-category="artes">Artes</button>
                    <button class="filter-btn" data-category="cultura">Cultura</button>
                </div>
                <div class="grid" id="eventos-grid">
                    <div class="loading"><div class="loading-spinner"></div></div>
                </div>
            </div>
        </div>

        <!-- PÁGINA DE AUTENTICAÇÃO (LOGIN/CADASTRO) -->
        <div id="auth" class="page">
             <div class="auth-container">
                <div id="login-view">
                    <div class="section-header"><h2>Login</h2></div>
                    <form id="login-form">
                        <div class="error-message" id="login-error"></div>
                        <div class="form-group">
                            <label class="form-label" for="login-email">Email</label>
                            <input type="email" class="form-input" id="login-email" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="login-password">Senha</label>
                            <input type="password" class="form-input" id="login-password" required>
                        </div>
                        <button type="submit" class="btn-submit">Entrar</button>
                    </form>
                    <p class="auth-toggle">Não tem uma conta? <a id="show-register">Cadastre-se</a></p>
                </div>
                <div id="register-view" style="display: none;">
                    <div class="section-header"><h2>Cadastro</h2></div>
                    <form id="register-form">
                        <div class="error-message" id="register-error"></div>
                        <div class="form-group">
                            <label class="form-label" for="register-name">Nome Completo</label>
                            <input type="text" class="form-input" id="register-name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="register-email">Email</label>
                            <input type="email" class="form-input" id="register-email" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="register-password">Senha (mínimo 6 caracteres)</label>
                            <input type="password" class="form-input" id="register-password" required>
                        </div>
                        <button type="submit" class="btn-submit">Criar Conta</button>
                    </form>
                    <p class="auth-toggle">Já tem uma conta? <a id="show-login">Faça Login</a></p>
                </div>
            </div>
        </div>

        <!-- PÁGINA DE PERFIL -->
        <div id="profile" class="page">
            <div class="profile-container">
                <form id="profile-form">
                    <div class="profile-header">
                        <div class="profile-pic-container">
                            <img src="https://placehold.co/120x120/f05537/FFFFFF?text=Perfil" id="profile-pic-preview" class="profile-pic" alt="Foto de Perfil">
                            <input type="file" id="profile-pic-upload" accept="image/*">
                            <label for="profile-pic-upload" id="upload-pic-label"><i class="fas fa-camera"></i></label>
                        </div>
                        <div class="profile-info">
                            <h3 id="profile-name-display">Nome do Usuário</h3>
                            <p id="profile-email-display">email@dominio.com</p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="profile-bio">Biografia / Resumo Pessoal</label>
                        <textarea id="profile-bio" class="form-textarea" placeholder="Conte um pouco sobre você..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="profile-location">Localização (Cidade/Estado)</label>
                            <input type="text" id="profile-location" class="form-input" placeholder="Ex: São Paulo, SP">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="profile-interests">Interesses (separados por vírgula)</label>
                            <input type="text" id="profile-interests" class="form-input" placeholder="Ex: música, esportes, workshops">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="profile-instagram">Instagram</label>
                            <input type="text" id="profile-instagram" class="form-input" placeholder="usuario_instagram">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="profile-twitter">Twitter (X)</label>
                            <input type="text" id="profile-twitter" class="form-input" placeholder="usuario_twitter">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Privacidade do Perfil</label>
                        <select id="profile-privacy" class="form-select">
                            <option value="public">Público - Todos podem ver seu perfil</option>
                            <option value="private">Privado - Apenas informações básicas são visíveis</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-submit">Salvar Alterações</button>
                </form>
            </div>
        </div>

        <!-- PÁGINA DE CRIAÇÃO DE EVENTO -->
        <div id="criar" class="page">
             <div class="form-container">
                <form id="event-form">
                    <div class="section-header">
                        <h2 id="form-title">Criar Novo Evento</h2>
                        <p>Compartilhe seu evento com a comunidade</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="event-type">Tipo de Evento</label>
                        <select class="form-select" id="event-type" required>
                            <option value="">Selecione o tipo</option>
                            <option value="barzinho">Barzinho</option>
                            <option value="trilha">Trilha</option>
                            <option value="musica">Música ao Vivo</option>
                            <option value="artes">Artes Visuais</option>
                            <option value="teatro">Teatro & Dança</option>
                            <option value="literatura">Literatura</option>
                            <option value="cultura">Cultura na Quebrada</option>
                            <option value="natureza">Natureza & Cultura</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="event-name">Nome do Evento</label>
                        <input type="text" class="form-input" id="event-name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="event-location">Local</label>
                        <input type="text" class="form-input" id="event-location" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="event-date">Data</label>
                            <input type="date" class="form-input" id="event-date" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="event-time">Horário</label>
                            <input type="time" class="form-input" id="event-time" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="event-description">Descrição</label>
                        <textarea class="form-textarea" id="event-description" placeholder="Detalhes sobre o evento..."></textarea>
                    </div>
                     <input type="hidden" id="event-creator-name">
                     <input type="hidden" id="event-creator-id">
                    <button type="submit" class="btn-submit" id="submit-btn">Criar Evento</button>
                </form>
            </div>
        </div>
        
        <!-- PÁGINA DE DETALHES DO EVENTO -->
        <div id="detalhes" class="page">
            <div class="detalhes-container" id="detalhes-content"></div>
        </div>
    </div>

    <button class="floating-btn" id="criar-evento-btn">
        <i class="fas fa-plus"></i>
    </button>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCQP5r1XeE03WWW-CPbHfqwYb50DN9T-V0",
            authDomain: "rolecertoeventos.firebaseapp.com",
            databaseURL: "https://rolecertoeventos-default-rtdb.firebaseio.com",
            projectId: "rolecertoeventos",
            storageBucket: "rolecertoeventos.appspot.com",
            messagingSenderId: "758496389166",
            appId: "1:758496389166:web:be8f89aa0cb3c8b72457bf"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();

        const eventosRef = db.ref('eventos');
        const usersRef = db.ref('users');
        
        // Elementos da UI
        const navContainer = document.getElementById('nav-container');
        const pages = document.querySelectorAll('.page');
        const eventosGrid = document.getElementById('eventos-grid');
        const categoryFilters = document.getElementById('category-filters');
        const criarEventoBtn = document.getElementById('criar-evento-btn');

        let currentFilter = 'all';
        let allEvents = {};
        let allUsers = {};

        // --- CONTROLE DE AUTENTICAÇÃO E UI ---
        
        auth.onAuthStateChanged(user => {
            if (user) {
                // Usuário está logado
                usersRef.child(user.uid).on('value', snapshot => { // Changed to .on for real-time updates
                    const userData = snapshot.val() || {};
                    updateUIForLoggedInUser(user, userData);
                });
            } else {
                // Usuário não está logado
                updateUIForLoggedOutUser();
            }
            // Sempre renderiza os eventos, independentemente do status de login
            fetchDataAndRender();
        });

        function updateUIForLoggedInUser(user, userData) {
            navContainer.innerHTML = `
                <button class="nav-btn active" data-page="eventos"><i class="fas fa-calendar-check"></i> Eventos</button>
                <button class="nav-btn" data-page="profile"><i class="fas fa-user"></i> Meu Perfil</button>
                <button class="nav-btn" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Sair</button>
            `;
            document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
            
            document.getElementById('event-creator-name').value = userData.name || user.displayName;
            document.getElementById('event-creator-id').value = user.uid;
            
            criarEventoBtn.style.display = 'flex';
            document.getElementById('create-event-hero').style.display = 'inline-block';

            setupNavButtons();
            populateProfileForm(user, userData);
        }

        function updateUIForLoggedOutUser() {
            navContainer.innerHTML = `
                <button class="nav-btn active" data-page="eventos"><i class="fas fa-home"></i> Início</button>
                <button class="nav-btn" data-page="auth" data-view="login"><i class="fas fa-sign-in-alt"></i> Login</button>
            `;
            criarEventoBtn.style.display = 'none';
            document.getElementById('create-event-hero').style.display = 'none';
            setupNavButtons();
        }

        function setupNavButtons() {
            document.querySelectorAll('.nav-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const targetPage = button.getAttribute('data-page');
                    showPage(targetPage);

                    if (targetPage === 'auth') {
                        const view = button.getAttribute('data-view');
                        showAuthView(view || 'login');
                    }
                });
            });
        }
        
        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.dataset.page === pageId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }


        // --- LÓGICA DE DADOS (FETCH) ---

        function fetchDataAndRender() {
            eventosGrid.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
            
            eventosRef.on('value', snapshot => {
                allEvents = snapshot.val() || {};
                renderEventos(currentFilter);
            });
            
            usersRef.on('value', snapshot => {
                allUsers = snapshot.val() || {};
                renderEventos(currentFilter);
            });
        }

        // --- RENDERIZAÇÃO DE EVENTOS ---

        function renderEventos(filterCategory = 'all') {
            eventosGrid.innerHTML = '';
            let hasActiveEvents = false;

            const sortedEventKeys = Object.keys(allEvents).sort((a, b) => {
                return new Date(allEvents[b].data) - new Date(allEvents[a].data);
            });

            sortedEventKeys.forEach(key => {
                const evento = { id: key, ...allEvents[key] };
                const eventDate = new Date(evento.data);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                if (eventDate >= today) {
                    if (filterCategory === 'all' || evento.tipo === filterCategory) {
                        const card = createEventCardNode(evento);
                        eventosGrid.appendChild(card);
                        hasActiveEvents = true;
                    }
                }
            });

            if (!hasActiveEvents) {
                eventosGrid.innerHTML = `<p style="text-align: center; padding: 30px; grid-column: 1 / -1;">Nenhum evento ativo encontrado para a categoria selecionada.</p>`;
            }
        }

        function createEventCardNode(evento) {
            const card = document.createElement('div');
            card.className = `event-card categoria-${evento.tipo}`;
            
            const creatorName = allUsers[evento.criadorId] ? allUsers[evento.criadorId].name : (evento.criadorName || "Anônimo");
            
            card.innerHTML = `
                <div class="card-header">
                    <h3 class="event-title">${evento.titulo}</h3>
                    <span class="event-badge">${formatarTipo(evento.tipo)}</span>
                </div>
                <div class="card-content">
                    <div class="event-info">
                        <i class="fas fa-calendar-alt"></i>
                        <div>${formatarDataCompleta(evento.data)} às ${evento.hora}</div>
                    </div>
                    <div class="event-info">
                        <i class="fas fa-map-marker-alt"></i>
                        <div>${evento.local}</div>
                    </div>
                    <div class="event-info">
                        <i class="fas fa-user"></i>
                        <div>Criado por <a href="#" class="event-creator-link" data-uid="${evento.criadorId}">${creatorName}</a></div>
                    </div>
                </div>
                <div class="card-footer">
                    <button class="card-btn details-btn" data-id="${evento.id}"><i class="fas fa-eye"></i> Detalhes</button>
                </div>
            `;
            
            card.querySelector('.details-btn').addEventListener('click', () => showEventDetails(evento.id));
            
            const creatorLink = card.querySelector('.event-creator-link');
            if(creatorLink) {
                creatorLink.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    // Implementar visualização de perfil público
                    alert(`Visualizando perfil de ${creatorName}`);
                });
            }
            
            return card;
        }


        // --- LÓGICA DOS FORMULÁRIOS ---

        // Auth
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');

        loginForm.addEventListener('submit', e => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            auth.signInWithEmailAndPassword(email, password)
                .then(() => showPage('eventos'))
                .catch(err => {
                    loginError.textContent = getAuthErrorMessage(err.code);
                    loginError.style.display = 'block';
                });
        });

        registerForm.addEventListener('submit', e => {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;

            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    usersRef.child(user.uid).set({
                        name: name,
                        email: email,
                        privacy: 'public',
                    });
                    return user.updateProfile({ displayName: name });
                })
                .then(() => showPage('eventos'))
                .catch(err => {
                    registerError.textContent = getAuthErrorMessage(err.code);
                    registerError.style.display = 'block';
                });
        });

        // Evento
        const eventForm = document.getElementById('event-form');
        eventForm.addEventListener('submit', e => {
            e.preventDefault();
            if (!auth.currentUser) {
                alert("Você precisa estar logado para criar um evento.");
                showPage('auth');
                return;
            }
            const eventData = {
                titulo: document.getElementById('event-name').value,
                tipo: document.getElementById('event-type').value,
                data: document.getElementById('event-date').value,
                hora: document.getElementById('event-time').value,
                local: document.getElementById('event-location').value,
                descricao: document.getElementById('event-description').value,
                criadorName: document.getElementById('event-creator-name').value,
                criadorId: document.getElementById('event-creator-id').value,
                criadoEm: new Date().toISOString(),
            };
            eventosRef.push(eventData)
                .then(() => {
                    alert('Evento criado com sucesso!');
                    eventForm.reset();
                    showPage('eventos');
                })
                .catch(error => console.error("Erro ao criar evento:", error));
        });
        
        // Perfil
        const profileForm = document.getElementById('profile-form');
        profileForm.addEventListener('submit', e => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;
            
            const profileData = {
                bio: document.getElementById('profile-bio').value,
                location: document.getElementById('profile-location').value,
                interests: document.getElementById('profile-interests').value,
                privacy: document.getElementById('profile-privacy').value,
                socials: {
                    instagram: document.getElementById('profile-instagram').value,
                    twitter: document.getElementById('profile-twitter').value,
                }
            };
            
            usersRef.child(user.uid).update(profileData)
                .then(() => alert("Perfil atualizado com sucesso!"))
                .catch(err => alert("Erro ao atualizar perfil: " + err.message));
        });
        
        document.getElementById('profile-pic-upload').addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            
            const user = auth.currentUser;
            if (!user) return;
            
            const filePath = `profile_pictures/${user.uid}/${file.name}`;
            const fileRef = storage.ref(filePath);
            
            fileRef.put(file).then(snapshot => {
                return snapshot.ref.getDownloadURL();
            }).then(url => {
                document.getElementById('profile-pic-preview').src = url;
                return usersRef.child(user.uid).update({ profilePicUrl: url });
            }).then(() => {
                alert("Foto de perfil atualizada!");
            }).catch(err => {
                console.error("Erro no upload:", err);
                alert("Falha no upload da foto.");
            });
        });


        // --- NAVEGAÇÃO E HELPERS ---

        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            fetchDataAndRender();
        });

        function setupEventListeners() {
            categoryFilters.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    currentFilter = e.target.dataset.category;
                    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    renderEventos(currentFilter);
                }
            });
            
            document.getElementById('show-register').addEventListener('click', () => showAuthView('register'));
            document.getElementById('show-login').addEventListener('click', () => showAuthView('login'));
            
            criarEventoBtn.addEventListener('click', () => {
                 if (auth.currentUser) {
                    showPage('criar');
                } else {
                    alert("Faça login ou cadastre-se para criar um evento.");
                    showPage('auth');
                }
            });
            document.getElementById('create-event-hero').addEventListener('click', () => {
                if (auth.currentUser) {
                    showPage('criar');
                } else {
                    alert("Faça login ou cadastre-se para criar um evento.");
                    showPage('auth');
                }
            });
            document.getElementById('explore-events').addEventListener('click', () => showPage('eventos'));
        }
        
        function populateProfileForm(user, userData) {
            document.getElementById('profile-name-display').textContent = userData.name || user.displayName;
            document.getElementById('profile-email-display').textContent = user.email;
            document.getElementById('profile-bio').value = userData.bio || '';
            document.getElementById('profile-location').value = userData.location || '';
            document.getElementById('profile-interests').value = userData.interests || '';
            document.getElementById('profile-privacy').value = userData.privacy || 'public';
            if (userData.socials) {
                document.getElementById('profile-instagram').value = userData.socials.instagram || '';
                document.getElementById('profile-twitter').value = userData.socials.twitter || '';
            }
            if (userData.profilePicUrl) {
                document.getElementById('profile-pic-preview').src = userData.profilePicUrl;
            } else {
                document.getElementById('profile-pic-preview').src = 'https://placehold.co/120x120/f05537/FFFFFF?text=Perfil';
            }
        }

        function showAuthView(view) {
            document.getElementById('login-view').style.display = view === 'login' ? 'block' : 'none';
            document.getElementById('register-view').style.display = view === 'register' ? 'block' : 'none';
            loginError.style.display = 'none';
            registerError.style.display = 'none';
        }
        
        function showEventDetails(eventId) {
            const evento = allEvents[eventId];
            alert(`Detalhes do Evento:\n\nTítulo: ${evento.titulo}\nLocal: ${evento.local}\nDescrição: ${evento.descricao}`);
        }

        function formatarTipo(tipo) {
            const tipos = { all: 'Todos', musica: 'Música', artes: 'Artes', teatro: 'Teatro', literatura: 'Literatura', cultura: 'Cultura', natureza: 'Natureza', barzinho: 'Barzinho', trilha: 'Trilha' };
            return tipos[tipo] || tipo;
        }

        function formatarDataCompleta(dataString) {
            const data = new Date(dataString);
            return data.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', timeZone: 'UTC' });
        }
        
        function getAuthErrorMessage(code) {
            switch (code) {
                case 'auth/wrong-password':
                    return 'Senha incorreta. Tente novamente.';
                case 'auth/user-not-found':
                    return 'Nenhum usuário encontrado com este e-mail.';
                case 'auth/weak-password':
                    return 'Sua senha deve ter pelo menos 6 caracteres.';
                case 'auth/email-already-in-use':
                    return 'Este e-mail já está cadastrado.';
                case 'auth/invalid-email':
                    return 'O formato do e-mail é inválido.';
                default:
                    return 'Ocorreu um erro. Tente novamente.';
            }
        }

    </script>
</body>
</html>
